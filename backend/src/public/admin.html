<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel – CivicSphere</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div style="padding: 0 var(--space-xl); margin-bottom: var(--space-xl);">
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                <img src="uploads/logo.png" alt="CivicSphere" style="width: 35px; height: 35px;">
                <div style="color: white; font-weight: 600;">CivicSphere</div>
            </div>
        </div>

        <ul class="sidebar-menu">
            <li><a href="admin.html">Dashboard</a></li>
            <li><a href="admin.html" class="active">Admin Panel</a></li>
            <li><a href="manage-complaints.html">Manage Complaints</a></li>
            <li><a href="users.html">User Management</a></li>
            <li><a href="reports.html">Reports</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-with-sidebar">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="#" class="back-button">← Back</a>
                <img src="uploads/logo.png" alt="CivicSphere Logo">
                <div>
                    <div class="top-bar-title">CivicSphere</div>
                    <div class="top-bar-subtitle">AI-Powered Complaint Management</div>
                </div>
            </div>
            <div class="user-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="content-area">
            <!-- HEADER -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h2 style="margin: 0; color: var(--text-dark); font-size: 1.75rem;">Admin Dashboard</h2>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-gray); font-size: 0.95rem;">Manage and monitor all
                        complaints</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="window.location.href='reports.html'"
                        style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 3v18h18" />
                            <path d="M18 17V9" />
                            <path d="M13 17V5" />
                            <path d="M8 17v-3" />
                        </svg>
                        Reports
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='manage-complaints.html'">View All
                        Complaints</button>
                </div>
            </div>

            <!-- STATISTICS CARDS -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2rem;">
                <!-- Total Card -->
                <div class="card" style="border-left: 4px solid #3b82f6;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <p
                                style="margin: 0; font-size: 0.875rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">
                                Total Complaints</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 2.25rem; font-weight: 700; color: var(--text-dark);"
                                id="stat-total">0</h3>
                        </div>
                        <div
                            style="width: 48px; height: 48px; background: #eff6ff; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Pending Card -->
                <div class="card" style="border-left: 4px solid #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <p
                                style="margin: 0; font-size: 0.875rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">
                                Pending</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 2.25rem; font-weight: 700; color: var(--text-dark);"
                                id="stat-pending">0</h3>
                        </div>
                        <div
                            style="width: 48px; height: 48px; background: #fef3c7; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- In Progress Card -->
                <div class="card" style="border-left: 4px solid #8b5cf6;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <p
                                style="margin: 0; font-size: 0.875rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">
                                In Progress</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 2.25rem; font-weight: 700; color: var(--text-dark);"
                                id="stat-progress">0</h3>
                        </div>
                        <div
                            style="width: 48px; height: 48px; background: #f3e8ff; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6"
                                stroke-width="2">
                                <polyline points="23 4 23 10 17 10" />
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Resolved Card -->
                <div class="card" style="border-left: 4px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <p
                                style="margin: 0; font-size: 0.875rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;">
                                Resolved</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 2.25rem; font-weight: 700; color: var(--text-dark);"
                                id="stat-resolved">0</h3>
                        </div>
                        <div
                            style="width: 48px; height: 48px; background: #d1fae5; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981"
                                stroke-width="2">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT GRID -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Recent Complaints -->
                <div class="card">
                    <div
                        style="border-bottom: 1px solid var(--border-light); padding-bottom: 1rem; margin-bottom: 1.25rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-dark);">Recent
                            Complaints</h3>
                    </div>
                    <div id="recent-complaints" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-gray);">Loading...</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div
                        style="border-bottom: 1px solid var(--border-light); padding-bottom: 1rem; margin-bottom: 1.25rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--text-dark);">Quick
                            Actions</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="hoverable quick-action" onclick="window.location.href='manage-complaints.html'">
                            <div class="quick-icon" style="background: var(--quick-icon-bg-1); color: var(--icon-primary);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                </svg>
                            </div>
                            <div class="quick-action-text">
                                <div class="quick-action-title">Manage Complaints</div>
                                <div class="quick-action-subtitle">View and update all complaints</div>
                            </div>
                        </button>

                        <button class="hoverable quick-action" onclick="window.location.href='users.html'">
                            <div class="quick-icon" style="background: var(--quick-icon-bg-2); color: var(--icon-warning);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                </svg>
                            </div>
                            <div class="quick-action-text">
                                <div class="quick-action-title">User Management</div>
                                <div class="quick-action-subtitle">Manage user accounts and roles</div>
                            </div>
                        </button>

                        <button class="hoverable quick-action" onclick="window.location.href='reports.html'">
                            <div class="quick-icon" style="background: var(--quick-icon-bg-3); color: var(--icon-accent);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3v18h18" />
                                    <path d="M18 17V9" />
                                    <path d="M13 17V5" />
                                    <path d="M8 17v-3" />
                                </svg>
                            </div>
                            <div class="quick-action-text">
                                <div class="quick-action-title">Analytics & Reports</div>
                                <div class="quick-action-subtitle">View detailed statistics</div>
                            </div>
                        </button>

                        <button class="hoverable quick-action" onclick="window.location.href='settings.html'">
                            <div class="quick-icon" style="background: var(--quick-icon-bg-4); color: var(--icon-success);">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3" />
                                    <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m-6 6l-4.2 4.2m16.4 0l-4.2-4.2m-6-6l-4.2-4.2" />
                                </svg>
                            </div>
                            <div class="quick-action-text">
                                <div class="quick-action-title">Settings</div>
                                <div class="quick-action-subtitle">Configure system settings</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/admin';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        async function loadDashboard() {
            try {
                const [analyticsRes, complaintsRes] = await Promise.all([
                    fetch(`${API_URL}/analytics`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/complaints?limit=5&sort=-createdAt`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const analytics = await analyticsRes.json();
                const complaintsData = await complaintsRes.json();

                // Update stats
                document.getElementById('stat-total').textContent = analytics.total || 0;

                // `byStatus` may be returned as an object map or as an array from different endpoints.
                // Normalize to a simple map to avoid runtime errors in the UI.
                const byStatus = analytics.byStatus || {};
                const statusMap = Array.isArray(byStatus)
                    ? byStatus.reduce((acc, s) => (acc[s._id] = s.count, acc), {})
                    : byStatus;

                document.getElementById('stat-pending').textContent = statusMap['Pending'] || 0;
                document.getElementById('stat-progress').textContent = statusMap['In Progress'] || 0;
                document.getElementById('stat-resolved').textContent = statusMap['Resolved'] || 0;

                renderRecentComplaints(complaintsData.complaints);
            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        function renderRecentComplaints(complaints) {
            const container = document.getElementById('recent-complaints');
            if (!complaints || complaints.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-gray);">No complaints yet</div>';
                return;
            }

            container.innerHTML = complaints.map(c => `
                <div class="recent-complaint" style="padding: 1rem; border: 1px solid var(--border-light); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="window.location.href='complaint-details.html?id=${c._id}'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">${c.title}</div>
                        <span class="badge ${getStatusClass(c.status)}" style="font-size: 0.75rem;">${c.status}</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-gray); margin-bottom: 0.75rem; line-height: 1.4;">${c.description.substring(0, 100)}${c.description.length > 100 ? '...' : ''}</div>
                    <div style="display: flex; gap: 1.25rem; font-size: 0.8rem; color: var(--text-gray);">
                        <span style="display: flex; align-items: center; gap: 0.35rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                            </svg>
                            ${c.user?.name || 'Unknown'}
                        </span>
                        <span style="display: flex; align-items: center; gap: 0.35rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${c.category}
                        </span>
                        <span style="display: flex; align-items: center; gap: 0.35rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            ${new Date(c.createdAt).toLocaleDateString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            if (status === 'Pending') return 'badge-open';
            if (status === 'In Progress') return 'badge-progress';
            if (status === 'Resolved') return 'badge-resolved';
            return '';
        }

        loadDashboard();
    </script>

    <script src="js/navigation.js"></script>
    <script src="js/theme-switcher.js"></script>

</body>

</html>